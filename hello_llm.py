import os
from dotenv import load_dotenv
from openai import OpenAI

# Load environment variables from .env file
load_dotenv()

# Get the OpenAI API key and Torob proxy URL from environment variables
api_key = os.getenv("OPENAI_API_KEY")
proxy_url = os.getenv("TOROB_PROXY_URL")

if not api_key:
    raise ValueError("OPENAI_API_KEY not found in .env file")
if not proxy_url:
    raise ValueError("TOROB_PROXY_URL not found in .env file")

# Initialize the OpenAI client
# Note: The proxy URL should be passed to the httpx client
client = OpenAI(
    api_key=api_key,
    base_url=proxy_url,
)

try:
    # Create a chat completion
    chat_completion = client.chat.completions.create(
        messages=[
            {
                "role": "user",
                "content": """
                Hello! How are you? Who are you?
                تعریف مسئله

شناسه شهر محل فروشگاه
score
امتیاز فروشگاه در ترب که از روی نتیجه پیگیری سفارش فروشگاه در ترب ساخته شده و عددی بین صفر تا پنج است.
has_warranty
آیا فروشگاه ضمانت ترب دارد

جدول دسته‌بندی‌ها (Categories)
نام ستون
توضیحات
id
شناسه دسته‌بندی
title
عنوان دسته‌بندی
parent_id
شناسه دسته بندی پدر، دسته‌بندی‌ها یک ساختار سلسله مراتبی دارن. که هر دسته یک پدر داره و ممکنه چندین فرزند داشته باشه. اگر پدری نداشته باشد، این فیلد مقدار -۱ دارد.

جدول برندها (Brands)
نام ستون
توضیحات
id
شناسه برند.
title
عنوان برند

جدول شهرها (cities)
نام ستون
توضیحات
id
شناسه شهر
name
عنوان شهر


فرمت API
ایجنت شما باید اندپوینت زیر رو پیاده‌سازی کرده باشه. 
اندپوینت /chat
این اندپوینت راه ارتباط کاربران با agent شما است. Judge مسابقه از طریق متد POST به این اندپوینت ریکوست میز‌ند.
فرمت درخواست (Request)
درخواست ارسالی به این اندپوینت باید در قالب یک آبجکت JSON با ساختار زیر باشد:
ساختار اصلی درخواست:
JSON
{
  "chat_id": "string",
  "messages": [
    {
      "type": "string",
      "content": "string"
    }
  ]
}


توضیحات فیلدها:
فیلد chat_id فرمت (string, required): شناسه منحصر به فرد برای هر سشن چت که برای شناسایی و پیگیری چت استفاده می‌شود.
فیلد messages فرمت (array of objects, required): لیستی از پیام‌های ارسالی توسط کاربر. هر پیام یک آبجکت با ساختار زیر است:
فیلد type فرمت (string, required): نوع پیام را مشخص می‌کند. این فیلد تنها می‌تواند یکی از دو مقدار زیر را داشته باشد:
"text": برای پیام‌های متنی.
"image": برای پیام‌های تصویری.
فیلد content فرمت (string, required): محتوای پیام.
اگر type برابر با "text" باشد، این فیلد حاوی متن پیام است.
اگر type برابر با "image" باشد، این فیلد حاوی یک رشته base64-encoded از تصویر است.
فرمت پاسخ (Response)
پاسخ این اندپوینت در قالب یک آبجکت JSON با ساختار زیر خواهد بود:
ساختار اصلی پاسخ:
JSON
{
  "message": "string",
  "base_random_keys": ["string"],
  "member_random_keys": ["string"]
}


توضیحات فیلدها:
فیلد message فرمت (string, optional): پاسخ متنی که باید به کاربر نمایش داده شود. این فیلد می‌تواند در برخی موارد null باشد.
فیلد base_random_keys فرمت (array of strings, optional): لیستی از کلیدهای تصادفی مربوط به محصولات پایه که ممکن است در پاسخ استفاده شوند. این فیلد می‌تواند null باشد. حداکثر طول لیست باید ۱۰ باشد. (وقتی کاربر به دنبال یک محصول خاص هست باید این فیلد پر باشد.)
فیلد member_random_keys فرمت (array of strings, optional): لیستی از کلیدهای تصادفی مربوط به محصولات member. این فیلد نیز می‌تواند null باشد.  حداکثر طول لیست باید ۱۰ باشد. (وقتی کاربر به دنبال یک فروشنده خاص هست باید این فیلد پر باشد.)
مثال از اندپوینت /chat
نمونه درخواست (Request)
JSON
{
  "chat_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "messages": [
    {
      "type": "text",
      "content": "سلام، یک گوشی آیفون ۱۶ پرومکس میخوام"
    }
  ]
}


نمونه پاسخ (Response)
سیستم پس از پردازش درخواست، یک پیام تأیید به همراه کلیدهای تصادفی مربوط به محصول پایه برمی‌گرداند.
JSON
{
  "message": "این گوشی رو به شما پیشنهاد میکنم.",
  "base_random_keys": ["awsome-gooshi-rk"],
  "member_random_keys": null
}

نحوه ارزیابی
هر کس باید کد خودش رو به صورت کامل دیپلوی کنه و یک دامنه برای ما ارسال کنه. دامنه باید باید یک اندپوینت chat داشته باشه که با توضیحات بالا کار کنه.
این مسابقه یک public leaderboard و یک private leaderboard داره. شما در طول مسابقه می‌تونید از طریق پنل مسابقه درخواست بدید که به دامنه‌ای که در اختیار ما گذاشتید ریکوست بزنیم و نحوه پاسخ‌دهی دستیار شما به این ریکوست‌ها public leaderboard رو درست میکنه.
ریکوست‌هایی که روز آخر مسابقه (۴ مهر) به سرویس شما میزنیم متفاوت هست (سناریو سوالات مشابه ولی ورودی دقیقا یکسان نیست.) و نتیجه این ریکوست‌هاست که private leaderboard رو تعیین میکنه.
همچنین برای اینکه در داوری باشید لازم است کارهای زیر را انجام دهید:
ساخت و ارسال یک ویدیو ۵ دقیقه شامل معماری، چالش‌ها، امکانات پیاده‌سازی شده و … در انتهای پروژه
دسترسی به ریپو کدهای خودتون در همگیت به اکانت recruiter@torob.ir

در ادامه با توجه به نتایج این داوری تعدادی از تیم‌ها به مرحله مصاحبه راه پیدا خواهند کرد. در مرحله مصاحبه آنلاین یک مصاحبه ۳۰ دقیقه‌ای با نفرات برتر انجام میدیم و در نهایت نفرات برتر نهایی تعیین میشوند.

سناریو‌های ارزیابی
سناریو‌های در نظر گرفته شده برای مسابقه به شرح زیر است. در ابتدای مسابقه فقط judge برای سناریو یک فعال هست و در ادامه به مرور judge برای سوالات دیگر هم فعال شده و اطلاع‌رسانی انجام خواهد شد.
سناریو صفر
این سناریو برای اطمینان از اتصال صحیح جاج با سرویس طراحی شده است. 
ورودی (Request)
خروجی (Response)
{ "chat_id": "sanity-check-ping", "messages": [ { "type": "text", "content": "ping" } ] }
{ "message": "pong", "base_random_keys": null, "member_random_keys": null }
{ "chat_id": "sanity-check-base-key", "messages": [ { "type": "text", "content": "return base random key: 123e4567-e89b-12d3-a456-426614174000" } ] }
{ "message": null, "base_random_keys": ["123e4567-e89b-12d3-a456-426614174000"], "member_random_keys": null }
{ "chat_id": "sanity-check-member-key", "messages": [ { "type": "text", "content": "return member random key: abc-def-123" } ] }
{ "message": null, "base_random_keys": null, "member_random_keys": ["abc-def-123"] }

نکته: فرمت ورودی دقیقا به شکل گفته شده و فرمت خروجی دقیقا به شکل گفته شده ولی مقادیر random_key ممکن است متفاوت باشد.
تاریخ فعال‌سازی:‌ ۲۴ شهریور
امتیاز: ۵۰
سناریو یک
ورودی: کاربر دنبال یک محصول مشخص از ترب میگرده (کوئری کاربر رو میشه دقیقا به یک بیس ترب مپ کرد.)
خروجی: در یک مرحله‌ رندوم کی بیس در خروجی داده بشه. (در قسمت base_random_keys)
مثال: 

ورودی (Request)
خروجی (Response)
{ "chat_id": "q1-abc", "messages": [ { "type": "text", "content": "لطفاً دراور چهار کشو (کد D14) را برای من تهیه کنید." } ] }
{ "message": null, "base_random_keys": ["bmubxu"], "member_random_keys": null }

نکته: در این سوال base_random_keys باید حداکثر یک نتیجه داشته باشد.
تاریخ فعال‌سازی:‌ ۲۵ شهریور
امتیاز: ۱۵۰
سناریو دو
ورودی: کاربر دنبال یک ویژگی خاص از یک محصول مشخص از ترب میگرده (کوئری کاربر رو میشه دقیقا به یک بیس ترب مپ کرد.)
خروجی: در یک مرحله‌ مقدار ویژگی مورد نظر برای اون محصول رو برگردونیم. (در قسمت message)
مثال:

ورودی (Request)
خروجی (Response)
{ "chat_id": "q2-abc", "messages": [ { "type": "text", "content": "عرض پارچه تریکو جودون 1/30 لاکرا گردباف نوریس به رنگ زرد طلایی چقدر است؟" } ] }
{ "message": "1.18 meter", "base_random_keys": null, "member_random_keys": null }

نکته: لازم نیست دقیقا مقدار 1.18 متر در پاسخ برگردونده بشه. مقادیر "1.18 متر" و "عرض پارچه ۱.۱۸ متر است." و "۱۱۸ سانتی‌متر" هم قابل قبول است.
تاریخ فعال‌سازی:‌ ۲۵ شهریور
امتیاز: ۱۵۰
سناریو سه
ورودی: کاربر سوالی در مورد فروشنده‌های یک بیس مشخص از ترب داره. (کوئری کاربر رو میشه دقیقا به یک بیس ترب مپ کرد.)
خروجی: در یک مرحله‌ سوالی که کاربر پرسیده رو جواب بده. (در قسمت message)
مثال:

ورودی (Request)
خروجی (Response)
{ "chat_id": "q3-abc", "messages": [ { "type": "text", "content": "کمترین قیمت در این پایه برای گیاه طبیعی بلک گلد بنسای نارگل کد ۰۱۰۸ چقدر است؟" } ] }
{ "message": "275000", "base_random_keys": null, "member_random_keys": null }

نکته: خروجی باید قابل پارس کردن به این int یا float باشد. (با توجه به خواسته سوال)
تاریخ فعال‌سازی:‌ ۲۵ شهریور
امتیاز: ۲۰۰
سناریو چهار
هدف: کاربر دنبال یک فروشنده خاص میگرده ولی کوئری اولیه رو نمیشه به یک محصول خاص مربوط کرد دستیار باید با پرسش و پاسخ با کاربر کمک کنه به هدفش برسه.
خروجی: نهایت ۵ مرحله فرصت داره با کاربر چت کنه در نهایت دستیار باید محصول مورد نظر رو در قسمت member_random_keys بزاره. (هر زمان این کار رو انجام بده judge فرآیند رو خاتمه میده.)
مثال:

ورودی (Request)
خروجی (Response)
{ "chat_id": "q4-abc", "messages": [ { "type": "text", "content": "ن دنبال یه میز تحریر هستم که برای کارهای روزمره و نوشتن مناسب باشه. می‌خواستم بدونم آیا می‌تونید به من کمک کنید تا یه فروشنده خوب پیدا کنم؟ ممنون می‌شم اگه راهنمایی کنید." } ] }
{ "message": null, "base_random_keys": null, "member_random_keys": ["xpjtgd"]}

نکته:‌ همونطور که مشخص هست از کوئری اولیه نمیشه مستقیم به اون محصول رسید ولی با توجه به اسپک‌های محصولاتی که تو دسته بخاری برقی هست ایجنت باید یک سری سوال بپرسه که در نهایت به محصول مورد نظر برسه. مثلا فن‌دار میخوای یا بی فن چه توانی میخوای چه برندی میخوای و … دقت بکنید که در این سوال judge میدونه که چی میخواد ولی این رو در پرامپت اولیه مستقیما نمیگه.
نکته ۲: در نهایت در این سوال member_random_keys باید حداکثر یک نتیجه داشته باشد.
تاریخ فعال‌سازی:‌ ۲۷ شهریور
امتیاز: ۳۰۰
سناریو پنج
ورودی: مقایسه دو یا چند بیس مشخص (کوئری کاربر رو میشه دقیقا به دو تا بیس مپ کرد.) با توجه به یک کاربرد مشخص
خروجی: در یک مرحله‌ باید دقیقا بگه که کدوم محصول بهتره و چرا؟ 
مثال:

ورودی (Request)
خروجی (Response)
{ "chat_id": "q5-abc", "messages": [ { "type": "text", "content": "کدام یک از این ماگ‌های خرید ماگ-لیوان هندوانه فانتزی و کارتونی کد 1375 یا ماگ لته خوری سرامیکی با زیره کد 741 دارای سبک کارتونی و فانتزی بوده و برای کودکان یا نوجوانان مناسب‌تر است؟" } ] }
{ "message": "چون طراحی کارتونی و فانتزی دارد که برای افراد جوان‌تر یا کسانی که از محیط‌های شاد و غیررسمی لذت می‌برند، جذابیت بیشتری دارد.", "base_random_keys": ["hhtgaa"], "member_random_keys": null }
                """,
            }
        ],
        model="gpt-5-mini",
    )

    # Print the response
    print("LLM call successful!")
    print(chat_completion.choices[0].message.content)

except Exception as e:
    print(f"An error occurred: {e}")
